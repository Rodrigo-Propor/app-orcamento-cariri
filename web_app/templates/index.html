<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento MVP</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- AG Grid -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-theme-alpine.css">

    <style>
        .ag-theme-alpine {
            --ag-header-height: 30px;
            --ag-row-height: 30px;
            font-size: 13px;
        }
        .origin-calculated { color: green; font-weight: bold; }
        .origin-po { color: blue; font-weight: bold; }
        .origin-none { color: red; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-gray-100">

    <!-- Header -->
    <header class="bg-white border-b p-3 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-gray-700">Orçamento Cariri - MVP</h1>
            
            <!-- View Switcher -->
            <div class="flex bg-gray-100 rounded p-1">
                <button id="btn-view-grid" onclick="switchView('grid')" class="px-3 py-1 rounded bg-white shadow text-xs font-bold text-gray-700 transition-all">TABELA</button>
                <button id="btn-view-detail" onclick="switchView('detail')" class="px-3 py-1 rounded text-xs font-medium text-gray-500 hover:text-gray-700 transition-all">DETALHADO</button>
                <button onclick="resetGridState()" class="ml-2 px-2 py-1 rounded text-[10px] text-red-400 hover:text-red-600 border border-transparent hover:border-red-200" title="Resetar colunas">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
            </div>
        </div>
        <div class="text-sm text-gray-500">FastAPI + HTMX + AG Grid</div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden" id="main-container">
        
        <!-- Left Sidebar: EAP -->
        <aside id="left-sidebar" style="width: 300px;" class="bg-white border-r flex flex-col overflow-hidden">
            <div class="p-3 border-b bg-gray-50 font-semibold text-xs text-gray-600 uppercase flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span>EAP</span>
                    <div class="flex bg-white rounded border shadow-sm">
                        <button onclick="toggleEAP(true)" class="px-1.5 py-0.5 hover:bg-gray-100 text-gray-500 border-r" title="Expandir Tudo">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                        <button onclick="toggleEAP(false)" class="px-1.5 py-0.5 hover:bg-gray-100 text-gray-500" title="Recolher (Nível 1)">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                        </button>
                    </div>
                </div>
                <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full" id="item-count">0 itens</span>
            </div>
            <div class="p-2 border-b">
                <input type="text" placeholder="Filtrar EAP..." class="w-full border rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" id="eap-filter">
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-0.5" id="eap-list">
                <!-- EAP Items will be populated via JS -->
                <div class="text-gray-400 text-sm text-center mt-10">Carregando itens...</div>
            </div>
        </aside>

        <!-- Left Resizer -->
        <div id="resizer-left" class="w-1 bg-gray-200 cursor-col-resize hover:bg-blue-400 z-10 transition-colors"></div>

        <!-- Center Area -->
        <main class="flex-1 flex flex-col min-w-0 bg-white relative">
            
            <!-- VIEW 1: Grid -->
            <div id="grid-view" class="w-full h-full flex flex-col">
                <div id="myGrid" class="ag-theme-alpine w-full h-full"></div>
            </div>

            <!-- VIEW 2: Detail (Hidden initially) -->
            <div id="detail-view" class="w-full h-full hidden bg-gray-50 overflow-y-auto relative">
                <div id="detail-content" class="max-w-5xl mx-auto p-8">
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400 mt-20">
                        <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <h2 class="text-xl font-semibold text-gray-500">Selecione um item</h2>
                        <p class="text-sm mt-1">Navegue pela estrutura ao lado para ver a composição detalhada.</p>
                    </div>
                </div>
            </div>

        </main>

        <!-- Right Resizer -->
        <div id="resizer-right" class="w-1 bg-gray-200 cursor-col-resize hover:bg-blue-400 z-10 transition-colors"></div>

        <!-- Right Sidebar: Inspector (Only for Grid View) -->
        <aside id="inspector-panel" style="width: 320px;" class="bg-white border-l flex flex-col overflow-hidden shadow-lg z-20 transition-transform duration-300">
            <div class="p-3 border-b bg-gray-50 font-semibold text-sm text-gray-700 flex justify-between items-center">
                <span>Inspetor de Detalhes</span>
                <span class="text-xs text-gray-400">Selecione um item</span>
            </div>
            <div id="inspector-content" class="flex-1 overflow-y-auto p-4">
                <div class="text-center text-gray-400 mt-10">
                    <p>Clique em um item na tabela para ver os detalhes da composição.</p>
                </div>
            </div>
        </aside>

    </div>

    <script>
        let currentMode = 'grid'; // 'grid' or 'detail'
        let gridApi = null;

        function switchView(mode) {
            currentMode = mode;
            const btnGrid = document.getElementById('btn-view-grid');
            const btnDetail = document.getElementById('btn-view-detail');
            const viewGrid = document.getElementById('grid-view');
            const viewDetail = document.getElementById('detail-view');
            const inspector = document.getElementById('inspector-panel');
            const resizerRight = document.getElementById('resizer-right');

            if (mode === 'grid') {
                // Activate Grid
                btnGrid.classList.add('bg-white', 'shadow', 'text-gray-700', 'font-bold');
                btnGrid.classList.remove('text-gray-500', 'font-medium');
                
                btnDetail.classList.remove('bg-white', 'shadow', 'text-gray-700', 'font-bold');
                btnDetail.classList.add('text-gray-500', 'font-medium');

                viewGrid.classList.remove('hidden');
                viewDetail.classList.add('hidden');
                inspector.classList.remove('hidden'); // Show sidebar
                resizerRight.classList.remove('hidden'); // Show resizer
            } else {
                // Activate Detail
                btnDetail.classList.add('bg-white', 'shadow', 'text-gray-700', 'font-bold');
                btnDetail.classList.remove('text-gray-500', 'font-medium');

                btnGrid.classList.remove('bg-white', 'shadow', 'text-gray-700', 'font-bold');
                btnGrid.classList.add('text-gray-500', 'font-medium');

                viewGrid.classList.add('hidden');
                viewDetail.classList.remove('hidden');
                inspector.classList.add('hidden'); // Hide sidebar
                resizerRight.classList.add('hidden'); // Hide resizer
            }
        }

        function toggleEAP(expand) {
            const items = document.querySelectorAll('#eap-list div');
            const filterInput = document.getElementById('eap-filter');
            filterInput.value = ''; // Clear filter to avoid confusion

            items.forEach(div => {
                const level = parseInt(div.getAttribute('data-level') || '0');
                if (expand) {
                    div.style.display = 'flex';
                } else {
                    // Collapse: Show only Level 0 (1, 2, 3...) and maybe Level 1 (1.1, 1.2...) depending on preference.
                    // Let's show only Level 0 for maximum collapse.
                    if (level === 0) {
                        div.style.display = 'flex';
                    } else {
                        div.style.display = 'none';
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Resizing Logic ---
            const resizerLeft = document.getElementById('resizer-left');
            const leftSidebar = document.getElementById('left-sidebar');
            const resizerRight = document.getElementById('resizer-right');
            const rightSidebar = document.getElementById('inspector-panel');

            // Left Resizer
            resizerLeft.addEventListener('mousedown', (e) => {
                e.preventDefault();
                document.addEventListener('mousemove', resizeLeft);
                document.addEventListener('mouseup', stopResizeLeft);
                document.body.style.cursor = 'col-resize';
                resizerLeft.classList.add('bg-blue-400');
            });

            function resizeLeft(e) {
                const newWidth = e.clientX - leftSidebar.getBoundingClientRect().left;
                if (newWidth > 150 && newWidth < 600) {
                    leftSidebar.style.width = `${newWidth}px`;
                }
            }

            function stopResizeLeft() {
                document.removeEventListener('mousemove', resizeLeft);
                document.removeEventListener('mouseup', stopResizeLeft);
                document.body.style.cursor = 'default';
                resizerLeft.classList.remove('bg-blue-400');
                if(gridApi) gridApi.sizeColumnsToFit(); // Optional: adjust grid
            }

            // Right Resizer
            resizerRight.addEventListener('mousedown', (e) => {
                e.preventDefault();
                document.addEventListener('mousemove', resizeRight);
                document.addEventListener('mouseup', stopResizeRight);
                document.body.style.cursor = 'col-resize';
                resizerRight.classList.add('bg-blue-400');
            });

            function resizeRight(e) {
                const newWidth = document.body.clientWidth - e.clientX;
                if (newWidth > 200 && newWidth < 800) {
                    rightSidebar.style.width = `${newWidth}px`;
                }
            }

            function stopResizeRight() {
                document.removeEventListener('mousemove', resizeRight);
                document.removeEventListener('mouseup', stopResizeRight);
                document.body.style.cursor = 'default';
                resizerRight.classList.remove('bg-blue-400');
                if(gridApi) gridApi.sizeColumnsToFit();
            }
            // --- End Resizing Logic ---

            const gridDiv = document.querySelector('#myGrid');
            
            const columnDefs = [
                { field: "idx", headerName: "Item", width: 80, pinned: 'left' },
                { field: "source", headerName: "Fonte", width: 100 },
                { field: "code", headerName: "Código", width: 100 },
                { field: "desc", headerName: "Descrição", flex: 1, minWidth: 200 },
                { field: "unit", headerName: "Unid", width: 60 },
                { field: "qty", headerName: "Qtd", width: 80, type: 'numericColumn' },
                { 
                    field: "final_unit_price", 
                    headerName: "Unit. (Base)", 
                    width: 100, 
                    type: 'numericColumn',
                    valueFormatter: params => params.value ? 'R$ ' + params.value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
                },
                { 
                    field: "bdi_percent", 
                    headerName: "BDI %", 
                    width: 70, 
                    type: 'numericColumn',
                    valueFormatter: params => params.value ? (params.value * 100).toFixed(2) + '%' : ''
                },
                { 
                    field: "unit_price_with_bdi", 
                    headerName: "Unit. (c/ BDI)", 
                    width: 110, 
                    type: 'numericColumn',
                    valueFormatter: params => params.value ? 'R$ ' + params.value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
                },
                { 
                    field: "total_price", 
                    headerName: "Total (Base)", 
                    width: 110, 
                    type: 'numericColumn',
                    valueFormatter: params => params.value ? 'R$ ' + params.value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
                },
                { 
                    field: "total_price_with_bdi", 
                    headerName: "Total (c/ BDI)", 
                    width: 120, 
                    type: 'numericColumn',
                    valueFormatter: params => params.value ? 'R$ ' + params.value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''
                },
                { 
                    field: "origin", 
                    headerName: "Origem", 
                    width: 100,
                    cellClass: params => {
                        if (params.value === 'CALCULADO') return 'origin-calculated';
                        if (params.value === 'PO_MANUAL') return 'origin-po';
                        return 'origin-none';
                    }
                }
            ];

            const gridOptions = {
                columnDefs: columnDefs,
                defaultColDef: {
                    sortable: true,
                    filter: true,
                    resizable: true
                },
                rowSelection: 'single',
                animateRows: true,
                onRowSelected: onRowSelected,
                onGridReady: (params) => {
                    gridApi = params.api;
                    // Restore column state if exists
                    const savedState = localStorage.getItem('orcamento_grid_state');
                    if (savedState) {
                        params.api.applyColumnState({
                            state: JSON.parse(savedState),
                            applyOrder: true
                        });
                    }
                    // Fit columns if no state or just once? 
                    // Let's rely on state. If no state, default widths apply.
                },
                // Save state on changes
                onColumnResized: saveGridState,
                onColumnMoved: saveGridState,
                onColumnVisible: saveGridState,
                onSortChanged: saveGridState
            };

            function saveGridState() {
            if (gridApi) {
                const state = gridApi.getColumnState();
                localStorage.setItem('orcamento_grid_state', JSON.stringify(state));
            }
        }

        function resetGridState() {
            localStorage.removeItem('orcamento_grid_state');
            location.reload();
        }

        // Initialize Grid
            new agGrid.Grid(gridDiv, gridOptions);

            // Fetch Data
            fetch('/api/grid')
                .then(response => response.json())
                .then(data => {
                    gridOptions.api.setRowData(data);
                    populateEAP(data);
                });

            function onRowSelected(event) {
                if(event.node.selected) {
                    const code = event.data.code;
                    if(code) {
                        // Only load inspector if in Grid Mode
                        if(currentMode === 'grid') {
                            htmx.ajax('GET', `/api/item/${code}`, '#inspector-content');
                        }
                    } else {
                        if(currentMode === 'grid') {
                            document.getElementById('inspector-content').innerHTML = '<div class="text-center text-gray-400 mt-10">Item sem código (Cabeçalho)</div>';
                        }
                    }
                }
            }
            
            // Simple EAP Population
            function populateEAP(data) {
                const list = document.getElementById('eap-list');
                const countBadge = document.getElementById('item-count');
                list.innerHTML = '';
                countBadge.textContent = `${data.length} itens`;
                
                data.forEach((item, index) => {
                    if (item.type === 'HEADER' || (item.idx)) {
                        const div = document.createElement('div');
                        // Base styling
                        div.className = "cursor-pointer hover:bg-blue-50 px-2 py-1.5 rounded text-sm truncate transition-colors duration-150 group flex items-center gap-2 select-none";
                        
                        // Hierarchical Data Attributes
                        div.setAttribute('data-idx', item.idx);
                        const parts = item.idx.split('.');
                        const parentIdx = parts.length > 1 ? parts.slice(0, -1).join('.') : '';
                        div.setAttribute('data-parent', parentIdx);

                        // Indentation
                        const dots = (item.idx.match(/\./g) || []).length;
                        div.style.paddingLeft = `${dots * 12 + 4}px`; // Reduced base padding to fit arrow
                        div.setAttribute('data-level', dots);
                        
                        // Check for children
                        let hasChildren = false;
                        if (index < data.length - 1) {
                            const nextItem = data[index + 1];
                            if (nextItem.idx.startsWith(item.idx + '.')) {
                                hasChildren = true;
                            }
                        }
                        
                        // Also check if it is a composition that can be expanded dynamically
                        const isComposition = item.type !== 'HEADER' && item.code;
                        if (isComposition) {
                             // We assume it might have children if it's an item (lazy check later)
                             // Actually, for PO items, we know if they are compositions if we check backend, 
                             // but here we might just want to show the arrow if it's a valid item code.
                             // However, user wants "seta para abrir". 
                             // If we don't know for sure, we might show it and then find empty.
                             // Ideally backend sends "has_children" for PO items too. 
                             // But let's assume all valid ITEMS with codes might be compositions.
                             // Better yet, let's treat it as hasChildren if type is ITEM.
                             // But we need to distinguish between "already loaded children (PO subitems)" and "lazy composition".
                             if (!hasChildren) {
                                 hasChildren = true; // Potentially expandable
                                 div.setAttribute('data-lazy', 'true');
                                 div.setAttribute('data-code', item.code);
                             }
                        }

                        // Toggle Button or Spacer
                        const toggleSpan = document.createElement('span');
                        toggleSpan.className = "w-4 h-4 flex items-center justify-center flex-shrink-0 text-gray-400";
                        if (hasChildren) {
                            toggleSpan.innerHTML = `<svg class="w-3 h-3 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                            toggleSpan.classList.add('hover:text-gray-700', 'cursor-pointer');
                            div.setAttribute('data-expanded', 'true'); // Default open
                            
                            toggleSpan.onclick = (e) => {
                                e.stopPropagation();
                                toggleNode(item.idx, div);
                            };
                        } else {
                            toggleSpan.innerHTML = `<span class="w-1 h-1 rounded-full bg-gray-300"></span>`; // Dot for leaf
                        }
                        div.appendChild(toggleSpan);

                        // Content
                        const contentSpan = document.createElement('span');
                        contentSpan.className = "truncate flex-1 flex gap-2 items-center";
                        
                        if(item.type === 'HEADER') {
                            div.classList.add('font-bold', 'text-gray-800');
                            contentSpan.innerHTML = `<span class="text-gray-400 text-xs w-10 flex-shrink-0 text-right">${item.idx}</span> <span class="truncate">${item.desc}</span>`;
                        } else {
                            div.classList.add('text-gray-600');
                            contentSpan.innerHTML = `<span class="text-gray-400 text-xs w-10 flex-shrink-0 text-right font-mono">${item.idx}</span> <span class="truncate group-hover:text-blue-700">${item.desc}</span>`;
                        }
                        div.appendChild(contentSpan);
                        
                        // Unified Click Handler (Selection)
                        div.onclick = () => {
                            // Highlight in EAP
                            document.querySelectorAll('#eap-list div').forEach(d => d.classList.remove('bg-blue-100', 'text-blue-800'));
                            div.classList.add('bg-blue-100', 'text-blue-800');

                            if (currentMode === 'grid') {
                                // Find row in grid
                                gridOptions.api.forEachNode(node => {
                                    if (node.data.idx === item.idx) {
                                        node.setSelected(true);
                                        gridOptions.api.ensureIndexVisible(node.rowIndex);
                                    }
                                });
                            } else {
                                // Detail Mode
                                if(item.code) {
                                    htmx.ajax('GET', `/api/item/${item.code}`, '#detail-content');
                                } else {
                                    document.getElementById('detail-content').innerHTML = `
                                        <div class="flex flex-col items-center justify-center h-64 text-gray-400 mt-20">
                                            <h2 class="text-xl font-bold text-gray-800">${item.desc}</h2>
                                            <p class="text-sm">Item de cabeçalho</p>
                                        </div>
                                    `;
                                }
                            }
                        };

                        list.appendChild(div);
                    }
                });
            }

            // Recursive Toggle Logic
            async function toggleNode(parentIdx, parentDiv) {
                const isExpanded = parentDiv.getAttribute('data-expanded') === 'true';
                const newState = !isExpanded;
                
                // Check if lazy load needed
                if (newState && parentDiv.getAttribute('data-lazy') === 'true' && parentDiv.getAttribute('data-loaded') !== 'true') {
                    const code = parentDiv.getAttribute('data-code');
                    
                    // Show loading state
                    const svg = parentDiv.querySelector('svg');
                    if(svg) svg.classList.add('animate-spin');

                    try {
                        const response = await fetch(`/api/composition/${code}`);
                        const children = await response.json();
                        
                        if (children.length > 0) {
                            parentDiv.setAttribute('data-loaded', 'true');
                            
                            // Append children
                            const list = document.getElementById('eap-list');
                            const parentLevel = parseInt(parentDiv.getAttribute('data-level'));
                            
                            // Find insertion point: after this div, but before any next sibling that is NOT a descendant of this div (conceptually)
                            // Since we are expanding a leaf (in PO terms), we can just insert after it.
                            // But if we already expanded it before, we wouldn't be here (data-loaded check).
                            // Wait, if we are expanding a node, we should insert its children immediately after it.
                            
                            // Reverse loop to insert after
                            // Actually, just inserting after parentDiv is enough, but we need to reverse list to keep order or insert one by one in reverse?
                            // appendChild appends to end. insertBefore does the trick.
                            
                            let referenceNode = parentDiv.nextSibling;
                            
                            children.forEach(child => {
                                const div = document.createElement('div');
                                div.className = "cursor-pointer hover:bg-blue-50 px-2 py-1.5 rounded text-sm truncate transition-colors duration-150 group flex items-center gap-2 select-none";
                                
                                // Create synthetic IDX for visual hierarchy
                                const childIdx = `${parentIdx}.${child.code}`;
                                div.setAttribute('data-idx', childIdx);
                                div.setAttribute('data-parent', parentIdx);
                                div.setAttribute('data-level', parentLevel + 1);
                                div.setAttribute('data-code', child.code);
                                if (child.has_children) {
                                    div.setAttribute('data-lazy', 'true');
                                }
                                
                                div.style.paddingLeft = `${(parentLevel + 1) * 12 + 4}px`;
                                div.style.backgroundColor = '#f8fafc'; // Slightly different bg for composition items?

                                // Toggle/Spacer
                                const toggleSpan = document.createElement('span');
                                toggleSpan.className = "w-4 h-4 flex items-center justify-center flex-shrink-0 text-gray-400";
                                if (child.has_children) {
                                    toggleSpan.innerHTML = `<svg class="w-3 h-3 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                                    toggleSpan.classList.add('hover:text-gray-700', 'cursor-pointer');
                                    toggleSpan.onclick = (e) => {
                                        e.stopPropagation();
                                        toggleNode(childIdx, div);
                                    };
                                } else {
                                    toggleSpan.innerHTML = `<span class="w-1 h-1 rounded-full bg-gray-300"></span>`;
                                }
                                div.appendChild(toggleSpan);

                                // Content
                                const contentSpan = document.createElement('span');
                                contentSpan.className = "truncate flex-1 flex gap-2 items-center text-gray-500";
                                contentSpan.innerHTML = `<span class="text-xs w-14 flex-shrink-0 text-right font-mono text-gray-400">${child.code}</span> <span class="truncate hover:text-blue-600">${child.desc}</span>`;
                                div.appendChild(contentSpan);

                                // Click handler
                                div.onclick = () => {
                                     document.querySelectorAll('#eap-list div').forEach(d => d.classList.remove('bg-blue-100', 'text-blue-800'));
                                     div.classList.add('bg-blue-100', 'text-blue-800');
                                     // Open detail
                                     if(currentMode === 'detail') {
                                         htmx.ajax('GET', `/api/item/${child.code}`, '#detail-content');
                                     }
                                };

                                // Insert
                                list.insertBefore(div, referenceNode);
                                // Since we insertBefore referenceNode, the next child should be inserted before referenceNode too (after the one we just added? No).
                                // If we iterate children: [A, B, C].
                                // Insert A before Ref. List: Parent, A, Ref.
                                // Insert B before Ref. List: Parent, A, B, Ref.
                                // Correct.
                            });

                        } else {
                            // No children found (maybe a material?)
                            parentDiv.removeAttribute('data-lazy');
                            // Remove arrow
                            const span = parentDiv.querySelector('span:first-child');
                            if(span) span.innerHTML = `<span class="w-1 h-1 rounded-full bg-gray-300"></span>`;
                            // And return, don't expand
                            if(svg) svg.classList.remove('animate-spin');
                            return; 
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        if(svg) svg.classList.remove('animate-spin');
                    }
                }

                parentDiv.setAttribute('data-expanded', newState);
                
                // Rotate Icon
                const svg = parentDiv.querySelector('svg');
                if(svg) {
                    svg.style.transform = newState ? 'rotate(0deg)' : 'rotate(-90deg)';
                }

                if (!newState) {
                    // CLOSE: Hide all descendants recursively
                    const allItems = document.querySelectorAll(`#eap-list div`);
                    allItems.forEach(div => {
                        const idx = div.getAttribute('data-idx');
                        if (idx && idx.startsWith(parentIdx + '.')) {
                            div.style.display = 'none';
                            // Also collapse them? Optional.
                        }
                    });
                } else {
                    // OPEN: Show immediate children, and recurse if they are open
                    showChildren(parentIdx);
                }
            }

            function showChildren(parentIdx) {
                // Find immediate children
                const allItems = document.querySelectorAll(`#eap-list div`);
                allItems.forEach(div => {
                    const pIdx = div.getAttribute('data-parent');
                    if (pIdx === parentIdx) {
                        div.style.display = 'flex';
                        // If this child is also expanded, show its children
                        if (div.getAttribute('data-expanded') === 'true') {
                            showChildren(div.getAttribute('data-idx'));
                        }
                    }
                });
            }

            // EAP Filter
            document.getElementById('eap-filter').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const items = document.querySelectorAll('#eap-list div');
                items.forEach(div => {
                    if(div.textContent.toLowerCase().includes(term)) {
                        div.style.display = 'flex';
                    } else {
                        div.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>
